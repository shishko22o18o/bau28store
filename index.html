<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bau28Store ¬∑ –ú–∞–≥–∞–∑–∏–Ω –≤ Telegram</title>
    <style>
        :root {
            --bg-color: #0d0914;
            --primary: #b829ff;
            --primary-glow: rgba(184, 41, 255, 0.4);
            --secondary: #8a2be2;
            --surface: rgba(25, 18, 35, 0.6);
            --surface-border: rgba(184, 41, 255, 0.2);
            --text-main: #ffffff;
            --text-muted: #a097b0;
            --danger: #ff4444;
            --heart: #ff4081;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            min-height: 100vh;
            background: var(--bg-color);
            color: var(--text-main);
            position: relative;
            overflow-x: hidden;
        }

        /* –§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ */
        .bg-custom {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: url('images/fon.jpg');
            background-size: cover;
            background-position: center;
            opacity: 0.15;
            z-index: 0;
            pointer-events: none;
        }

        /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä—ã –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã */
        ::-webkit-scrollbar { display: none; }
        
        .app {
            position: relative;
            z-index: 10;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px 16px 120px;
        }

        /* –®–∞–ø–∫–∞ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .logo {
            font-size: 32px;
            font-weight: 900;
            letter-spacing: 2px;
            background: linear-gradient(to right, #e0b3ff, #b829ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px var(--primary-glow);
        }

        .top-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .top-btn {
            background: var(--surface);
            border: 1px solid var(--surface-border);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            width: 44px; height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            position: relative;
            transition: 0.2s ease;
            color: var(--text-main);
        }

        .top-btn:active { transform: scale(0.9); }

        .badge {
            position: absolute;
            top: -5px; right: -5px;
            background: var(--heart);
            color: white;
            font-size: 11px;
            font-weight: 800;
            padding: 2px 6px;
            border-radius: 10px;
            border: 2px solid var(--bg-color);
        }

        /* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª) */
        .categories {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            padding-bottom: 10px;
        }

        .cat-btn {
            flex: 0 0 110px;
            scroll-snap-align: start;
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            cursor: pointer;
            aspect-ratio: 1/1.2;
            background-size: cover;
            background-position: center;
            border: 2px solid transparent;
            transition: 0.3s;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding: 10px;
        }

        .cat-btn::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.1) 100%);
            z-index: 1;
        }

        .cat-btn span {
            position: relative;
            z-index: 2;
            color: white;
            font-weight: 700;
            font-size: 13px;
            text-align: center;
        }

        .cat-btn.active {
            border-color: var(--primary);
            box-shadow: 0 0 15px var(--primary-glow);
            transform: translateY(-3px);
        }

        .cat-btn[data-cat="clothes"] { background-image: url('images/cat_odezhda.jpg'); }
        .cat-btn[data-cat="accessories"] { background-image: url('images/cat_aksessuary.jpg'); }
        .cat-btn[data-cat="vape"] { background-image: url('images/cat_vape.jpg'); }
        .cat-btn[data-cat="electronics"] { background-image: url('images/cat_elektronika.jpg'); }

        /* –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –§–∏–ª—å—Ç—Ä—ã */
        .pills-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            margin-bottom: 20px;
            padding-bottom: 5px;
        }

        .pill {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--surface-border);
            border-radius: 40px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            white-space: nowrap;
            transition: 0.2s;
        }

        .pill.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 12px var(--primary-glow);
        }

        /* –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .product-card {
            background: var(--surface);
            backdrop-filter: blur(12px);
            border: 1px solid var(--surface-border);
            border-radius: 24px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: 0.3s ease;
            animation: fadeIn 0.4s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .product-card:active { transform: scale(0.97); }

        .product-img {
            width: 100%;
            aspect-ratio: 1/1;
            background: rgba(0,0,0,0.3);
            position: relative;
        }

        .product-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .discount-badge {
            position: absolute;
            top: 10px; left: 10px;
            background: var(--danger);
            color: white;
            font-size: 11px;
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .product-info {
            padding: 12px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .product-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            line-height: 1.3;
            color: var(--text-main);
            flex-grow: 1;
        }

        .product-price {
            color: #dbb6ff;
            font-weight: 800;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .old-price {
            text-decoration: line-through;
            color: var(--text-muted);
            font-weight: 500;
            font-size: 12px;
            margin-right: 6px;
        }

        .product-actions {
            display: flex;
            gap: 8px;
        }

        .btn-add {
            flex-grow: 1;
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            border: none;
            color: white;
            font-weight: 700;
            font-size: 13px;
            padding: 10px;
            border-radius: 14px;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-add:active { transform: scale(0.95); }

        .btn-fav {
            background: rgba(255,255,255,0.1);
            border: none;
            width: 38px; height: 38px;
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-fav:active { transform: scale(0.9); }

        /* –ü–ª–∞–≤–∞—é—â–∞—è –∫–æ—Ä–∑–∏–Ω–∞ */
        .cart-fixed {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 400px;
            background: rgba(20, 15, 28, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid var(--surface-border);
            border-radius: 30px;
            padding: 8px 8px 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 20px var(--primary-glow);
            transition: 0.3s ease;
        }

        .cart-fixed.hidden { transform: translate(-50%, 150%); }

        .cart-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .cart-total {
            font-weight: 800;
            font-size: 16px;
        }

        .checkout-btn {
            background: var(--primary);
            border: none;
            color: white;
            font-weight: 700;
            padding: 12px 24px;
            border-radius: 24px;
            cursor: pointer;
            transition: 0.2s;
        }
        .checkout-btn:active { transform: scale(0.95); }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ (Bottom Sheet) */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .bottom-sheet {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            background: #150f1d;
            border-radius: 32px 32px 0 0;
            border-top: 1px solid var(--surface-border);
            padding: 24px 20px 40px;
            transform: translateY(100%);
            transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }
        .modal-overlay.active .bottom-sheet { transform: translateY(0); }

        .sheet-handle {
            width: 40px; height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            margin: 0 auto 20px;
        }

        .sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 20px;
        }

        .close-btn {
            background: rgba(255,255,255,0.1);
            border: none; color: white;
            width: 32px; height: 32px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }

        .sheet-body {
            overflow-y: auto;
            flex-grow: 1;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface);
            padding: 12px 16px;
            border-radius: 20px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .cart-item-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .cart-item-price { color: var(--primary); font-weight: 800; }

        .qty-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            padding: 4px;
        }

        .qty-btn {
            background: var(--surface);
            border: none; color: white;
            width: 28px; height: 28px;
            border-radius: 50%;
            font-weight: 800; cursor: pointer;
        }

        .sheet-footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .order-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none; color: white;
            font-weight: 800; font-size: 16px;
            padding: 16px;
            border-radius: 20px;
            cursor: pointer;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ */
        .notification {
            position: fixed;
            top: -60px; left: 50%;
            transform: translateX(-50%);
            background: rgba(184, 41, 255, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: 600;
            z-index: 1000;
            transition: 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .notification.show { top: 20px; }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loader {
            text-align: center;
            color: var(--text-muted);
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="bg-custom"></div>

    <div class="app">
        <div class="header">
            <div class="logo">Bau28</div>
            <div class="top-actions">
                <button class="top-btn" id="topFavBtn">
                    ‚ù§Ô∏è<span class="badge" id="favBadge" style="display:none;">0</span>
                </button>
            </div>
        </div>

        <div class="categories" id="categories">
            <div class="cat-btn active" data-cat="clothes"><span>–û–¥–µ–∂–¥–∞</span></div>
            <div class="cat-btn" data-cat="accessories"><span>–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</span></div>
            <div class="cat-btn" data-cat="vape"><span>VAPE</span></div>
            <div class="cat-btn" data-cat="electronics"><span>–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞</span></div>
        </div>

        <div class="pills-container" id="vapeSubcats" style="display: none;">
            <div class="pill active" data-sub="liquids">–ñ–∏–¥–∫–æ—Å—Ç–∏</div>
            <div class="pill" data-sub="consumables">–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏</div>
            <div class="pill" data-sub="disposable">–û–¥–Ω–æ—Ä–∞–∑–∫–∏</div>
            <div class="pill" data-sub="pods">POD-—Å–∏—Å—Ç–µ–º—ã</div>
        </div>

        <div class="pills-container" id="filters">
            <div class="pill active" data-filter="all">–í—Å–µ</div>
            <div class="pill" data-filter="sale">üî• –°–∫–∏–¥–∫–∏</div>
            <div class="pill" data-filter="new">–ù–æ–≤–∏–Ω–∫–∏</div>
            <div class="pill" data-filter="priceAsc">–°–Ω–∞—á–∞–ª–∞ –¥–µ—à–µ–≤–ª–µ</div>
            <div class="pill" data-filter="priceDesc">–°–Ω–∞—á–∞–ª–∞ –¥–æ—Ä–æ–∂–µ</div>
        </div>

        <div id="loader" class="loader" style="display: none;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
        <div class="products-grid" id="productsGrid"></div>
    </div>

    <div class="cart-fixed hidden" id="floatingCart">
        <div class="cart-info">
            <div style="font-size:24px;">üõí</div>
            <div>
                <div style="font-size: 12px; color: var(--text-muted);">–í –∫–æ—Ä–∑–∏–Ω–µ <span id="cartCount">0</span> —à—Ç.</div>
                <div class="cart-total" id="cartTotal">0 ‚ÇΩ</div>
            </div>
        </div>
        <button class="checkout-btn" id="openCartBtn">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
    </div>

    <div class="modal-overlay" id="cartModal">
        <div class="bottom-sheet" onclick="event.stopPropagation()">
            <div class="sheet-handle"></div>
            <div class="sheet-header">
                <span>–ö–æ—Ä–∑–∏–Ω–∞</span>
                <button class="close-btn" id="closeCartBtn">‚úï</button>
            </div>
            <div class="sheet-body" id="cartItems"></div>
            <div class="sheet-footer">
                <div style="display:flex; justify-content:space-between; margin-bottom:16px; font-size:18px; font-weight:800;">
                    <span>–ò—Ç–æ–≥–æ:</span>
                    <span id="modalTotal">0 ‚ÇΩ</span>
                </div>
                <button class="order-btn" id="orderBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="favModal">
        <div class="bottom-sheet" onclick="event.stopPropagation()">
            <div class="sheet-handle"></div>
            <div class="sheet-header">
                <span>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
                <button class="close-btn" id="closeFavBtn">‚úï</button>
            </div>
            <div class="sheet-body" id="favItems"></div>
        </div>
    </div>

    <div class="notification" id="notification">‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ</div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
            // –ó–∞–º–µ–Ω–∏ –Ω–∞ URL —Å–≤–æ–µ–≥–æ –±–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, https://—Ç–≤–æ–π-–±–æ—Ç.up.railway.app)
            const API_BASE_URL = ''; // –û—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –ø–æ–∫–∞ –Ω–µ –Ω—É–∂–µ–Ω
            
            // –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
            const defaultProducts = {
                clothes: [
                    { id: 'c1', name: '–§—É—Ç–±–æ–ª–∫–∞ Oversize', price: 2990, img: 'images/tovary/futbolka.jpg', discount: 0, isNew: true },
                    { id: 'c2', name: '–•—É–¥–∏ —Å –ø—Ä–∏–Ω—Ç–æ–º', price: 4490, img: 'images/tovary/hudi.jpg', discount: 10 },
                    { id: 'c3', name: '–ö–∞—Ä–≥–æ —à—Ç–∞–Ω—ã', price: 3790, img: 'images/tovary/kargo.jpg' },
                    { id: 'c4', name: '–ë–µ–π—Å–±–æ–ª–∫–∞', price: 1990, img: 'images/tovary/bejsbolka.jpg', discount: 5 },
                ],
                accessories: [
                    { id: 'a1', name: '–ß–∞—Å—ã —Å—Ç–∞–ª—å/–∫–æ–∂–∞', price: 5490, img: 'images/tovary/chasy.jpg' },
                    { id: 'a2', name: '–û—á–∫–∏ Aviator', price: 2290, img: 'images/tovary/ochki.jpg' },
                    { id: 'a3', name: '–ß–æ–∫–µ—Ä —Å —à–∏–ø–∞–º–∏', price: 1190, img: 'images/tovary/choker.jpg' },
                ],
                vape: {
                    liquids: [
                        { id: 'v1', name: 'Bloody Mary 30ml', price: 890, img: 'images/tovary/liquid1.jpg' },
                        { id: 'v2', name: 'Ice Mint 30ml', price: 890, img: 'images/tovary/liquid2.jpg' },
                    ],
                    consumables: [
                        { id: 'v3', name: '–ò—Å–ø–∞—Ä–∏—Ç–µ–ª–∏ 0.6Œ©', price: 450, img: 'images/tovary/coils.jpg' },
                    ],
                    disposable: [
                        { id: 'v4', name: 'Elf Bar 600', price: 1290, img: 'images/tovary/elfbar.jpg' },
                    ],
                    pods: [
                        { id: 'v5', name: 'Caliburn G2', price: 2490, img: 'images/tovary/caliburn.jpg' },
                    ],
                },
                electronics: [
                    { id: 'e1', name: '–ë–µ—Å–ø—Ä–æ–≤–æ–¥–Ω—ã–µ –Ω–∞—É—à–Ω–∏–∫–∏', price: 3990, img: 'images/tovary/airpods.jpg' },
                    { id: 'e2', name: 'Power bank 10000', price: 2190, img: 'images/tovary/powerbank.jpg' },
                ]
            };

            // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
            let products = defaultProducts; // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥–ª—É—à–∫–∞
            let currentCat = 'clothes';
            let currentSub = 'liquids';
            let currentFilter = 'all';
            let cart = JSON.parse(localStorage.getItem('bau28_cart') || '[]');
            let favorites = JSON.parse(localStorage.getItem('bau28_fav') || '[]');

            // ==================== DOM –≠–õ–ï–ú–ï–ù–¢–´ ====================
            const productsGrid = document.getElementById('productsGrid');
            const floatingCart = document.getElementById('floatingCart');
            const notif = document.getElementById('notification');
            const favBadge = document.getElementById('favBadge');
            const loader = document.getElementById('loader');

            // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
            const formatPrice = (p) => p.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' ‚ÇΩ';
            
            function showNotification(text) {
                notif.textContent = text;
                notif.classList.add('show');
                setTimeout(() => notif.classList.remove('show'), 2000);
            }

            function findProduct(id) {
                for (let cat in products) {
                    if (cat === 'vape') {
                        for (let sub in products.vape) {
                            const found = products.vape[sub]?.find(p => p.id === id);
                            if (found) return found;
                        }
                    } else {
                        const found = products[cat]?.find(p => p.id === id);
                        if (found) return found;
                    }
                }
                return null;
            }

            // ==================== –ó–ê–ì–†–£–ó–ö–ê –¢–û–í–ê–†–û–í –° –°–ï–†–í–ï–†–ê ====================
            async function fetchProducts() {
                if (!API_BASE_URL) {
                    console.log('API_BASE_URL –Ω–µ –∑–∞–¥–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É—é –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
                    return;
                }
                loader.style.display = 'block';
                try {
                    const response = await fetch(`${API_BASE_URL}/api/products`);
                    if (response.ok) {
                        const serverProducts = await response.json();
                        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å, –µ—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç)
                        products = serverProducts;
                    } else {
                        console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞, –æ—Å—Ç–∞—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
                    }
                } catch (error) {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É:', error);
                } finally {
                    loader.style.display = 'none';
                    renderProducts(); // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                }
            }

            // ==================== –ö–û–†–ó–ò–ù–ê –ò –ò–ó–ë–†–ê–ù–ù–û–ï ====================
            window.changeQty = function(id, delta) {
                const item = cart.find(i => i.id === id);
                if (item) {
                    item.quantity += delta;
                    if (item.quantity <= 0) cart = cart.filter(i => i.id !== id);
                    updateCart();
                }
            };

            function updateCart() {
                localStorage.setItem('bau28_cart', JSON.stringify(cart));
                const totalItems = cart.reduce((s, i) => s + i.quantity, 0);
                const totalSum = cart.reduce((s, i) => s + i.price * i.quantity, 0);
                
                document.getElementById('cartCount').textContent = totalItems;
                document.getElementById('cartTotal').textContent = formatPrice(totalSum);
                document.getElementById('modalTotal').textContent = formatPrice(totalSum);
                
                if (totalItems > 0) floatingCart.classList.remove('hidden');
                else floatingCart.classList.add('hidden');

                renderCartItems();
            }

            function updateFavBadge() {
                localStorage.setItem('bau28_fav', JSON.stringify(favorites));
                if (favorites.length > 0) {
                    favBadge.style.display = 'block';
                    favBadge.textContent = favorites.length;
                } else {
                    favBadge.style.display = 'none';
                }
            }

            function renderCartItems() {
                const container = document.getElementById('cartItems');
                if (cart.length === 0) {
                    container.innerHTML = '<div style="text-align:center; color:var(--text-muted); margin-top:20px;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>';
                    return;
                }
                container.innerHTML = cart.map(item => `
                    <div class="cart-item">
                        <div>
                            <div class="cart-item-title">${item.name}</div>
                            <div class="cart-item-price">${formatPrice(item.price)}</div>
                        </div>
                        <div class="qty-controls">
                            <button class="qty-btn" onclick="changeQty('${item.id}', -1)">‚àí</button>
                            <span style="font-weight:700; width:20px; text-align:center;">${item.quantity}</span>
                            <button class="qty-btn" onclick="changeQty('${item.id}', 1)">+</button>
                        </div>
                    </div>
                `).join('');
            }

            function renderFavItems() {
                const container = document.getElementById('favItems');
                if (favorites.length === 0) {
                    container.innerHTML = '<div style="text-align:center; color:var(--text-muted); margin-top:20px;">–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö</div>';
                    return;
                }
                container.innerHTML = favorites.map(p => {
                    const price = p.discount ? Math.round(p.price * (1 - p.discount/100)) : p.price;
                    return `
                    <div class="cart-item">
                        <div>
                            <div class="cart-item-title">${p.name}</div>
                            <div class="cart-item-price">${formatPrice(price)}</div>
                        </div>
                        <button class="btn-add" style="width:auto; padding:8px 16px;" data-id="${p.id}">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                    </div>
                `}).join('');
            }

            // ==================== –û–¢–†–ò–°–û–í–ö–ê –ö–ê–¢–ê–õ–û–ì–ê ====================
            function renderProducts() {
                let items = currentCat === 'vape' ? (products.vape?.[currentSub] || []) : (products[currentCat] || []);
                
                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
                if (currentFilter === 'sale') items = items.filter(p => p.discount && p.discount > 0);
                if (currentFilter === 'new') items = items.filter(p => p.isNew);
                if (currentFilter === 'priceAsc') items.sort((a,b) => (a.discount ? a.price*(1-a.discount/100) : a.price) - (b.discount ? b.price*(1-b.discount/100) : b.price));
                if (currentFilter === 'priceDesc') items.sort((a,b) => (b.discount ? b.price*(1-b.discount/100) : b.price) - (a.discount ? a.price*(1-a.discount/100) : a.price));

                if (items.length === 0) {
                    productsGrid.innerHTML = '<div style="grid-column: span 2; text-align:center; color:var(--text-muted); padding:40px;">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }

                productsGrid.innerHTML = items.map(p => {
                    const finalPrice = p.discount ? Math.round(p.price * (1 - p.discount/100)) : p.price;
                    const isFav = favorites.some(f => f.id === p.id);
                    return `
                        <div class="product-card">
                            <div class="product-img">
                                ${p.discount ? `<div class="discount-badge">-${p.discount}%</div>` : ''}
                                <img src="${p.img}" alt="${p.name}" onerror="this.style.display='none'; this.parentNode.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;font-size:40px;\\'>üì¶</div>';">
                            </div>
                            <div class="product-info">
                                <div class="product-title">${p.name}</div>
                                <div class="product-price">
                                    ${p.discount ? `<span class="old-price">${formatPrice(p.price)}</span>` : ''}
                                    ${formatPrice(finalPrice)}
                                </div>
                                <div class="product-actions">
                                    <button class="btn-add" data-id="${p.id}">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                                    <button class="btn-fav" data-id="${p.id}">${isFav ? '‚ù§Ô∏è' : 'ü§ç'}</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // ==================== –°–û–ë–´–¢–ò–Ø ====================
            // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
            document.body.addEventListener('click', (e) => {
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É
                if (e.target.closest('.btn-add')) {
                    const id = e.target.closest('.btn-add').dataset.id;
                    const p = findProduct(id);
                    if (p) {
                        const existing = cart.find(i => i.id === p.id);
                        if (existing) existing.quantity++;
                        else cart.push({ 
                            id: p.id, 
                            name: p.name, 
                            price: p.discount ? Math.round(p.price * (1 - p.discount/100)) : p.price, 
                            quantity: 1 
                        });
                        updateCart();
                        showNotification('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É');
                    }
                }
                
                // –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
                if (e.target.closest('.btn-fav')) {
                    const btn = e.target.closest('.btn-fav');
                    const id = btn.dataset.id;
                    const p = findProduct(id);
                    if (p) {
                        const index = favorites.findIndex(f => f.id === p.id);
                        if (index === -1) {
                            favorites.push(p);
                            btn.textContent = '‚ù§Ô∏è';
                            showNotification('‚ù§Ô∏è –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º');
                        } else {
                            favorites.splice(index, 1);
                            btn.textContent = 'ü§ç';
                        }
                        updateFavBadge();
                    }
                }
            });

            // –ù–∞–≤–∏–≥–∞—Ü–∏—è (–ö–∞—Ç–µ–≥–æ—Ä–∏–∏)
            document.querySelectorAll('.cat-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCat = btn.dataset.cat;
                    document.getElementById('vapeSubcats').style.display = currentCat === 'vape' ? 'flex' : 'none';
                    if(currentCat === 'vape') currentSub = 'liquids';
                    renderProducts();
                });
            });

            // –ù–∞–≤–∏–≥–∞—Ü–∏—è (–ü–∏–ª—é–ª–∏ - –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Ñ–∏–ª—å—Ç—Ä—ã)
            document.querySelectorAll('.pill').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const parent = btn.parentElement;
                    parent.querySelectorAll('.pill').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    if (btn.dataset.sub) currentSub = btn.dataset.sub;
                    if (btn.dataset.filter) currentFilter = btn.dataset.filter;
                    renderProducts();
                });
            });

            // –ú–æ–¥–∞–ª–∫–∏
            const setupModal = (btnId, modalId, closeBtnId, renderFn) => {
                const modal = document.getElementById(modalId);
                document.getElementById(btnId).addEventListener('click', () => {
                    if(renderFn) renderFn();
                    modal.classList.add('active');
                });
                document.getElementById(closeBtnId).addEventListener('click', () => modal.classList.remove('active'));
                modal.addEventListener('click', () => modal.classList.remove('active'));
            };

            setupModal('openCartBtn', 'cartModal', 'closeCartBtn', renderCartItems);
            setupModal('topFavBtn', 'favModal', 'closeFavBtn', renderFavItems);

            // –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (Telegram + —Å–µ—Ä–≤–µ—Ä)
            document.getElementById('orderBtn').addEventListener('click', async () => {
                if (cart.length === 0) return;
                
                const orderData = {
                    items: cart.map(item => ({
                        id: item.id,
                        name: item.name,
                        quantity: item.quantity,
                        price: item.price
                    })),
                    total: cart.reduce((s,i) => s + i.price*i.quantity, 0)
                };
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
                const tg = window.Telegram?.WebApp;
                if (tg && tg.sendData) {
                    tg.sendData(JSON.stringify(orderData));
                } else {
                    alert('–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º. –ó–∞–∫–∞–∑: ' + JSON.stringify(orderData));
                }
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–µ—Å–ª–∏ API_BASE_URL –∑–∞–¥–∞–Ω)
                if (API_BASE_URL) {
                    try {
                        await fetch(`${API_BASE_URL}/api/order`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(orderData)
                        });
                    } catch (error) {
                        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', error);
                    }
                }
                
                cart = [];
                updateCart();
                document.getElementById('cartModal').classList.remove('active');
                showNotification('üöÄ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!');
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã —Å —Å–µ—Ä–≤–µ—Ä–∞, –∑–∞—Ç–µ–º –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
            (async () => {
                await fetchProducts();  // –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞
                renderProducts();       // –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º (–µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª, –æ—Å—Ç–∞–Ω—É—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–µ)
                updateCart();
                updateFavBadge();
            })();

            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.setHeaderColor('#0d0914');
            }
        });
    </script>
</body>
</html>
